# 회전 시 위치 추적 실패 문제 분석

## 🔴 **문제 증상**

**관찰된 현상:**
- ✅ **전진/후진**: 라이다 포인트가 지도의 검은 점(장애물)에 정확히 정합됨
- ❌ **좌우 회전**: 라이다 포인트가 지도를 벗어나고, 로버가 위치를 잃음

## 🔍 **원인 분석**

### 1. **라이다 센서가 후방을 향함**

```
현재 설치:
     로봇 정면 (+X)
          ↑
          |
      [로봇 본체]
          |
          ↓
   [라이다] ← 후방(-X)을 스캔
```

**URDF 설정:**
```xml
<origin xyz="-0.03 0 0.13" rpy="0 0 3.14159"/>  <!-- yaw=180° -->
```

**의미:**
- 라이다는 로봇 **후방**만 스캔
- 로봇 **정면**은 완전히 블라인드 영역

### 2. **전진/후진이 잘 되는 이유**

```
전진 시나리오:
1. 로봇이 앞으로 전진
2. 라이다는 뒤쪽을 계속 스캔
3. 이미 지나온 영역(이미 매핑됨)을 스캔
4. 스캔 매칭 성공 ✓

후진 시나리오:
1. 로봇이 뒤로 후진
2. 라이다가 새로운 영역 스캔
3. 새로운 장애물 감지 및 매핑
4. 스캔 매칭 성공 ✓
```

### 3. **회전이 실패하는 이유** ⚠️

```
시계방향 회전 시나리오:
1. 로봇이 제자리에서 시계방향 회전
2. 라이다는 후방 180° 범위만 스캔
3. 정면 180°는 완전히 블라인드

문제 발생:
┌─────────────────────┐
│   블라인드 영역    │ ← 정면 180°
│   (스캔 안 됨!)    │
├─────────────────────┤
│   [로봇]           │
│      ↓             │
│   [라이다]         │ ← 후방만 스캔
├─────────────────────┤
│   스캔 영역        │ ← 후방 180°
└─────────────────────┘

회전 시:
- 시계방향 90° 회전 → 왼쪽 벽이 블라인드 영역으로
- 반시계방향 90° 회전 → 오른쪽 벽이 블라인드 영역으로
- 스캔 매칭할 특징점 사라짐 ❌
- SLAM이 위치를 잃음 ❌
```

## 📊 **데이터 분석**

### 라이다 커버리지

```
전체 360° 중:
- 스캔 가능: 후방 180° (angle_min=-1.5 ~ angle_max=1.5)
- 블라인드: 정면 180° (완전히 보이지 않음)

커버리지: 50% ❌
```

### SLAM의 요구사항

**SLAM이 회전을 추적하려면:**
1. **회전 전**: 특징점 A, B, C를 스캔
2. **회전 중**: 같은 특징점 A, B, C가 다른 각도에서 보임
3. **회전 후**: 특징점 위치 변화로 회전량 계산

**현재 문제:**
```
회전 전:
- 특징점 A (후방 왼쪽)
- 특징점 B (후방 중앙)  
- 특징점 C (후방 오른쪽)

시계방향 90° 회전 후:
- 특징점 A → 블라인드 영역 (사라짐!) ❌
- 특징점 D (새로 나타남, 하지만 지도에 없음)
- 특징점 E (새로 나타남, 하지만 지도에 없음)

→ 연속성 상실! 스캔 매칭 불가능!
```

## 🔍 **EKF 설정 분석**

### 현재 EKF 설정

```yaml
# 오도메트리 (base_node)
odom0_config: [true, true, false,   # x, y 위치
              false, false, true,   # yaw 각도
              true, true, false,    # x, y 속도
              false, false, false,  # yaw 각속도 비활성화!
              false, false, false]

# IMU (imu_filter_madgwick)
imu0_config: [false, false, false,
              false, false, false,  # yaw 각도 비활성화
              false, false, false,
              false, false, true,   # yaw 각속도만 활성화
              false, false, false]
```

**문제점:**
1. **오도메트리 yaw 각속도 비활성화**
   - 휠 오도메트리의 회전 정보를 무시
   - IMU 각속도만 의존

2. **IMU만으로 회전 추정**
   - IMU 드리프트 누적
   - 라이다 스캔 매칭으로 보정 필요
   - 하지만 라이다가 50%만 커버 → 보정 실패

3. **SLAM의 역할 제한**
   - SLAM은 odom → map 변환 제공
   - 하지만 라이다 데이터 부족으로 정확한 보정 불가

## 🎯 **회전 실패 메커니즘**

```
시나리오: 로봇이 시계방향 90° 회전

1. 회전 시작
   ├─ 휠 오도메트리: "90° 회전했어요"
   ├─ IMU: "각속도 감지... 적분... 87° 회전?"
   └─ EKF: "휠 yaw 무시, IMU 각속도만 사용"

2. SLAM 스캔 매칭 시도
   ├─ 이전 스캔: 후방 벽 3개
   ├─ 현재 스캔: 새로운 벽 3개 (이전 벽들은 블라인드)
   ├─ 공통 특징점: 0개! ❌
   └─ 매칭 실패 → 위치 보정 불가

3. 결과
   ├─ IMU 드리프트: 87° (실제 90°)
   ├─ SLAM 보정: 실패 (특징점 부족)
   ├─ 최종 위치 추정: 3° 오차 누적
   └─ 라이다 포인트가 지도와 어긋남 ❌

4. 오차 누적
   ├─ 계속 회전하면 오차 계속 누적
   ├─ 5° → 10° → 15° ...
   └─ 결국 완전히 위치를 잃음 ❌
```

## 📊 **비교 분석**

### 전진/후진 (성공 케이스)

| 요소 | 상태 |
|------|------|
| 라이다 커버리지 | 후방 180° ✓ |
| 스캔 매칭 | 이전 프레임과 중복 큼 ✓ |
| 특징점 연속성 | 유지됨 ✓ |
| SLAM 보정 | 가능 ✓ |
| 오도메트리 정확도 | 직선 이동은 정확 ✓ |
| 결과 | 위치 추적 성공 ✓ |

### 회전 (실패 케이스)

| 요소 | 상태 |
|------|------|
| 라이다 커버리지 | 후방 180° (50%만) ❌ |
| 스캔 매칭 | 이전 프레임과 중복 거의 없음 ❌ |
| 특징점 연속성 | 상실됨 ❌ |
| SLAM 보정 | 불가능 ❌ |
| 오도메트리 정확도 | IMU 드리프트 누적 ❌ |
| 결과 | 위치 추적 실패 ❌ |

## 🔧 **근본 원인 요약**

### 1차 원인: 라이다 후방 설치 (50% 커버리지)
```
- 정면 180° 블라인드
- 회전 시 특징점 연속성 상실
- 스캔 매칭 불가능
```

### 2차 원인: EKF 설정
```
- 휠 오도메트리 yaw 각속도 미사용
- IMU 각속도만 의존 → 드리프트 누적
- SLAM 보정 불가로 오차 누적
```

### 3차 원인: SLAM 파라미터
```
- minimum_travel_heading: 0.05 rad (2.9°)
- 작은 회전도 감지하지만, 매칭할 특징점 없음
- 매칭 실패 → 위치 업데이트 안 됨
```

## 🎯 **해결 방향 제안**

### 옵션 1: 라이다 재설치 (하드웨어)
```
✓ 라이다를 정면을 향하도록 재설치
✓ 360° 커버리지 확보
❌ 하드웨어 수정 필요
```

### 옵션 2: EKF 설정 조정 (소프트웨어)
```
✓ 휠 오도메트리 yaw 각속도 활성화
✓ IMU와 휠 오도메트리 퓨전
✓ 회전 추정 정확도 향상
⚠️ 완벽한 해결은 아님 (라이다 커버리지 여전히 50%)
```

### 옵션 3: SLAM 파라미터 조정 (소프트웨어)
```
✓ minimum_travel_heading 증가 (작은 회전 무시)
✓ 회전 관련 tolerance 증가
⚠️ 정확도 저하 가능
```

### 옵션 4: 복합 접근
```
1. EKF에서 휠 오도메트리 각속도 활성화
2. IMU 가중치 감소, 휠 오도메트리 가중치 증가
3. SLAM 회전 매칭 tolerance 증가
4. 회전 속도 제한 (천천히 회전)
```

## 📝 **권장 조치**

### 즉시 적용 가능 (소프트웨어만)

1. **EKF 설정 수정**
   ```yaml
   odom0_config: [true, true, false,
                  false, false, true,
                  true, true, false,
                  false, false, true,   # ← yaw 각속도 활성화!
                  false, false, false]
   ```

2. **IMU 가중치 조정**
   ```yaml
   imu0_twist_rejection_threshold: 1.5  # 증가 (0.5 → 1.5)
   # IMU 각속도 신뢰도 낮춤, 휠 오도메트리 더 신뢰
   ```

3. **SLAM 회전 tolerance 증가**
   ```yaml
   angle_variance_penalty: 0.5  # 감소 (1.0 → 0.5)
   minimum_angle_penalty: 0.8   # 감소 (0.95 → 0.8)
   ```

### 장기적 해결책 (하드웨어)

**라이다를 정면으로 재설치:**
- URDF: `rpy="0 0 0"` (yaw=0°)
- 360° 중 정면 180° 스캔
- 전진 시 전방 장애물 감지
- 회전 시 특징점 연속성 유지

## 🎯 **결론**

**핵심 문제:**
> 라이다가 후방만 보기 때문에 회전 시 특징점 연속성이 상실되어 SLAM 스캔 매칭이 실패합니다.

**즉시 해결:**
> EKF에서 휠 오도메트리 yaw 각속도를 활성화하여 회전 추정 정확도를 향상시킵니다.

**완벽한 해결:**
> 라이다를 정면을 향하도록 재설치합니다.
