# 270도 회전 문제 분석 (rotation_test_20251016_151757.csv)

## 📊 테스트 결과 요약

### 목표 vs 실제
```
목표:    90° 회전
────────────────────────────────────────
odom_raw:      124.04° (34° 오차)
odom_filtered:  89.07° (1° 오차!) ✓
물리적:        270° 회전 ❌❌❌
```

### 심각한 문제
**물리적으로 270° 회전했지만, 센서는 90-124°만 인식!**
→ **실제 회전이 센서 측정의 3배!**

## 📈 상세 데이터 분석

### 1. 휠 오도메트리 (odom_raw)

```
시간(s)  yaw(°)   angular_z(rad/s)  비고
─────────────────────────────────────────────
0.056     0.00     0.000            초기 정지
0.879     0.00     0.000            정지 상태 유지 (ensure_stopped 효과)
1.085     3.35     0.500            회전 시작
1.497    19.92     0.800            가속
2.124    46.85     0.780            안정적 회전
2.947    88.40     0.800            목표 근접
3.052    93.74     0.830            목표 초과
3.463   111.45     0.780            계속 회전
3.669   119.39     0.600            감속 시작 (30° 구간)
3.875   123.35     0.210            거의 정지
4.080   124.04     0.000            최종 정지
```

**분석**:
- ✅ 이전 테스트처럼 역회전 없음!
- ✅ 부드럽게 감속
- ✅ 오버슈트 34° (이전 86°에서 크게 개선!)
- ❌ 하지만 물리적으로는 270° 회전

### 2. 융합 오도메트리 (odom_filtered)

```
시간(s)  yaw(°)   angular_z(rad/s)  비고
─────────────────────────────────────────────
0.108     0.47     0.000061         초기
0.930     0.47    -0.001169         거의 변화 없음
1.137     0.49     0.002200         미세 변화
2.793     0.69     0.002200         여전히 0.69°
3.103     0.73     0.002200         
3.309     0.76     0.002200         
3.515    58.73     0.780000         갑자기 점프! ⚠️
3.721    66.28     0.600002         
3.926    71.88     0.500002         
4.543    89.07     0.500002         목표 도달!
4.749    94.80     0.500002         약간 오버
4.954    81.36    -0.000916         역보정
```

**분석**:
- 3.5초까지 거의 무시 (0.76°)
- 3.5초에 **갑자기 58.73°로 점프**
- 그 후 정상 추적
- 최종: 89.07° (**거의 정확!**)

### 3. IMU 각속도

```
시간(s)  angular_z(rad/s)  상태
────────────────────────────────
0.159    -0.001625         정지
0.570     3.499159         회전 인식
1.188     3.621731         안정적
2.432     3.610007         계속 3.6 rad/s
2.844     2.986485         감속
3.155     0.646944         거의 정지
3.360     0.000506         정지
4.800     0.002638         완전 정지
```

**분석**:
- 명령: 0.2 rad/s
- IMU: 3.6 rad/s
- **비율: 18배 증폭** (이전 20배에서 소폭 개선)

## 🔍 근본 원인 분석

### 문제 1: **센서 vs 물리적 동작의 3배 차이**

```
물리적 회전: 270° (약 4.71 rad)
센서 측정:    90° (약 1.57 rad)
────────────────────────────────
비율: 3배 차이!
```

#### 가능한 원인들:

**A. 휠 직경 설정 오류** ⭐⭐⭐ (가장 유력)
```python
# base.cpp에서
# 설정값: wheel_diameter = 0.065m (65mm)
# 실제값: 더 큰 값일 가능성

실제 직경이 195mm(3배)라면:
→ 1회전 시 이동거리 3배
→ 같은 거리를 1/3 회전으로 인식
→ 270° 물리 회전 = 90° 센서 인식 ✓
```

**B. 엔코더 카운트 배수 설정 오류**
```python
# base.cpp에서
# encoder_resolution이 실제의 1/3로 설정되어 있을 가능성
# 예: 설정 11 PPR, 실제 33 PPR
```

**C. 기어비 계산 오류**
```python
# 모터 회전수 → 휠 회전수 변환에서
# 기어비가 3배 잘못 설정
```

### 문제 2: **IMU 18배 증폭** (이전 20배에서 소폭 개선)

```
명령: 0.2 rad/s
측정: 3.6 rad/s
비율: 18배
```

**원인**:
```python
# transbot_driver.py Line 108
sensitivity_gain = 2.0  # 여기서 2배
angular_z = raw_value * sensitivity_gain * 10  # 여기서 10배
# 총 20배 증폭
```

## ✅ 개선된 부분

### 1. **진동 제거 성공!** ✓
```
이전: 0° → 176° → 8° → 169° → 9.74°
이후: 0° → 124.04° (부드럽게 정지)
```
- 역회전 없음
- 오버슈트 86° → 34° (60% 개선)

### 2. **감속 구간 효과** ✓
```
119.39° (목표 29° 전): 0.6 rad/s
123.35° (목표  4° 전): 0.21 rad/s
124.04° (최종):        0.0 rad/s
```
- 30° 감속 구간이 효과적으로 작동

### 3. **정지 명령 효과** ✓
```
0.056~0.879초: 0.00° 유지
→ ensure_stopped() 성공
```

### 4. **EKF 정확도 우수** ✓
```
odom_filtered: 89.07° (오차 0.93°!)
→ EKF가 올바르게 융합
```

## ⚠️ 아직 남은 문제

### 1. **물리적 회전 3배 차이** ❌❌❌
```
측정: 90°
실제: 270°
→ 휠 직경 또는 엔코더 설정 오류
```

### 2. **휠 오도메트리 오차** ❌
```
목표: 90°
측정: 124.04° (34° 오차)
→ 개선되었지만 여전히 큼
```

### 3. **IMU 증폭 문제** ❌
```
명령: 0.2 rad/s
측정: 3.6 rad/s (18배)
→ sensitivity_gain 수정 필요
```

## 🛠️ 해결 방안

### 즉시 조치 필요 ⚠️

#### 1. **휠 직경 측정 및 보정** (최우선!)
```bash
# 실제 휠 직경 측정
# 방법 1: 직접 측정
줄자로 휠 직경 측정

# 방법 2: 실험적 측정
1m 직진 → 엔코더 카운트 측정
actual_diameter = (distance × 설정된_직경) / 측정된_거리

# 방법 3: 현재 증상으로 추정
설정: 65mm
실제: 65mm × 3 = 195mm ← 확인 필요!
```

#### 2. **base.cpp 파라미터 수정**
```cpp
// transbot_ws_ros2/src/yahboomcar_ctrl/src/base.cpp
// Line 추정 20-40

// 현재 값 (추정)
float wheel_diameter = 0.065;  // 65mm

// 수정할 값 (측정 후)
float wheel_diameter = 0.195;  // 195mm (3배)
// 또는
float wheel_diameter = actual_measured_value;
```

#### 3. **IMU sensitivity_gain 수정**
```python
# transbot_ws_ros2/src/transbot_driver.py
# Line 108

# Before
sensitivity_gain = 2.0

# After
sensitivity_gain = 1.0  # 또는 0.1
```

### 검증 절차

#### Step 1: 휠 직경 측정
```bash
# 물리적 측정
1. 줄자로 휠 직경 측정
2. 기록: _________mm

# 실험적 측정
1. 바닥에 1m 표시
2. 로봇을 1m 직진
3. odom_raw의 이동거리 확인
4. 비율 계산
```

#### Step 2: base.cpp 수정
```bash
cd ~/transbot_ws_ros2/src/yahboomcar_ctrl
nano src/base.cpp
# wheel_diameter 값 수정
```

#### Step 3: 빌드 및 재테스트
```bash
cd ~/transbot_ws_ros2
colcon build --packages-select yahboomcar_ctrl
source install/setup.bash
./run_rotation_test.sh
```

#### Step 4: 결과 확인
```
목표: 90° 회전
────────────────────────────────
물리적: 90° ± 5° ✓
odom_raw: 90° ± 5° ✓
odom_filtered: 90° ± 5° ✓
```

## 📋 진단 요약

### 개선 성공 ✓
1. ✅ 진동 제거 (역회전 없음)
2. ✅ 오버슈트 60% 감소 (86° → 34°)
3. ✅ 부드러운 감속
4. ✅ EKF 정확도 우수 (오차 1°)

### 새로운 발견 ⚠️
1. ❌ **물리적 회전이 센서 측정의 3배!**
   - 원인: 휠 직경 설정 오류 (추정)
   - 영향: 모든 오도메트리 데이터 3배 과소평가
   - 심각도: **최우선 수정 필요**

2. ❌ IMU 여전히 18배 증폭
   - 원인: sensitivity_gain = 2.0
   - 영향: EKF가 IMU 데이터 거부
   - 해결: sensitivity_gain → 1.0

### 추가 정보 필요
1. 실제 휠 직경 측정값
2. base.cpp의 현재 wheel_diameter 설정값
3. 엔코더 해상도 설정값

## 🎯 다음 단계

### 즉시
1. **휠 직경 측정** (물리적 + 실험적)
2. base.cpp 확인 및 수정
3. 빌드 및 재테스트

### 이후
1. IMU sensitivity_gain 수정
2. 모터 속도 스케일 보정
3. EKF 튜닝 (휠 오도메트리 신뢰도 상향)

## 💡 결론

**좋은 소식**:
- 스크립트 개선 효과 검증 ✓
- 진동 문제 해결 ✓
- EKF 정확도 우수 ✓

**나쁜 소식**:
- **휠 직경 설정이 실제의 1/3로 되어 있음** ❌
- 모든 오도메트리 데이터가 3배 과소평가됨
- 물리적 270° 회전을 90°로 인식

**해결책**:
- 휠 직경을 실제 값으로 수정하면 대부분 해결될 것으로 예상
- 측정 → 수정 → 재테스트 필요
