# 90도 회전 테스트 상세 분석 (rotation_test_20251016_150358.csv)

## 📊 테스트 개요

### 설정
- **목표**: 90° 좌회전
- **초기 각도**: 0°
- **각속도 명령**: 0.3 rad/s (17.2°/s)
- **테스트 시간**: 11.5초

### 결과
- **최종 각도**: 9.74°
- **오차**: 80.26° (목표 대비 89.2% 부족!)
- **문제**: 로봇이 회전 중 **역회전** 발생

## 📈 상세 데이터 분석

### 1. 휠 오도메트리 (odom_raw)

#### Phase 1: 정방향 회전 (0~3.4초)
```
시간(s)  yaw(°)   angular_z(rad/s)  상태
─────────────────────────────────────────────
0.056     0.00     0.000            정지
1.093     5.99     0.880            회전 시작
2.123    79.72     1.350            가속 완료
2.330    95.27     1.370            목표 초과!
3.154   166.59     1.340            계속 회전
3.360   176.65     0.800            감속 시작
```
**분석**: 2.3초에 이미 95°로 목표 초과, 하지만 계속 회전

#### Phase 2: 역회전 발생! (3.6~5.8초)
```
3.566   175.09    -0.160            역회전 시작 ⚠️
3.772   163.92    -1.110            급격한 역회전
3.977   148.62    -1.320            계속 역회전
4.185   133.43    -1.400            계속 역회전
5.217    52.50    -1.400            90° 이상 역회전
5.836     8.14    -0.990            거의 원점 복귀
```
**❌ 심각한 문제**: 176°까지 갔다가 8°까지 역회전!

#### Phase 3: 재회전 (6.0~8.3초)
```
6.042     8.89     0.190            정방향 재회전
6.249    21.13     1.220            가속
7.280    97.71     1.370            다시 90° 초과
8.309   169.08     0.580            감속
```
**분석**: 다시 정방향으로 회전 시작

#### Phase 4: 또 역회전! (8.5~10.7초)
```
8.515   167.51    -0.260            또 역회전 시작
8.720   158.90    -1.210            급격한 역회전
9.338   104.25    -1.400            계속 역회전
10.473   17.30    -1.160            거의 원점 복귀
10.678    9.91    -0.220            정지 근처
10.884    9.74     0.000            최종 정지
```
**❌ 반복**: 169°까지 갔다가 또 9.74°까지 역회전!

### 2. 융합 오도메트리 (odom_filtered)

```
시간(s)  yaw(°)   angular_z(rad/s)  상태
─────────────────────────────────────────────
0.107    -0.06    -0.000109         초기
1.144    -0.09    -0.002592         미세 변화
3.617    -8.38    -0.160000         갑자기 점프
4.443   -15.71    -0.160000         역회전 인식
8.515   -23.83    -0.160000         계속 음수
```

**분석**: 
- EKF가 정방향 회전을 거의 무시
- 역회전만 인식 (-0.16 rad/s)
- 최종: -15° 정도로 인식

### 3. IMU 각속도

```
시간(s)  angular_z(rad/s)  상태
────────────────────────────────────
0.366     4.644            정방향 회전
2.222     5.877            계속 정방향
7.589     1.389            감속
7.795    -2.882            역회전 시작 ⚠️
8.000    -4.821            역회전 가속
8.412    -5.909            최대 역회전
9.754    -4.030            역회전 계속
9.959    -0.111            정지
```

**분석**:
- 정방향: 5.8~6.0 rad/s (명령: 0.3 rad/s) → 20배
- 역회전: -5.9 rad/s → 마이너스도 20배!

## 🔍 문제 원인 분석

### 1. **진동(Oscillation) 발생**

**패턴**:
```
0° → 176° (오버슈트) → 8° (역회전) → 169° (오버슈트) → 9.74° (정지)
```

**원인**:
1. **과도한 오버슈트**
   - 목표: 90°
   - 실제: 176° (86° 초과!)
   - 이유: 감속 구간 너무 짧음 (20°)

2. **과보상(Over-correction)**
   - 오버슈트 감지 → 역방향 회전
   - 역방향도 너무 강함 (-1.4 rad/s)
   - 결과: 다시 언더슈트

3. **제어 루프 불안정**
   ```python
   # 현재 로직
   error = target - current
   if error > 0: 회전
   if error < 0: 역회전  ← 이것이 문제!
   ```

### 2. **감속 구간 부족**

```python
# 현재 설정
if remaining < 20°:  # 너무 짧음!
    speed *= scale
```

**문제**:
- 1.35 rad/s로 고속 회전 중
- 20° 남았을 때 감속 시작
- 관성으로 86° 오버슈트!

### 3. **역방향 보정의 과도함**

**코드**:
```python
twist.angular.z = angular_speed * (1.0 if error > 0 else -1.0)
```

**문제**:
- error < 0일 때 **전속력으로 역회전**
- 오버슈트를 보정하려다 언더슈트
- 진동 발생

## 🛠️ 적용된 개선 사항

### 1. **회전 속도 감소** ✅
```python
# Before
angular_speed = 0.3 rad/s

# After
angular_speed = 0.2 rad/s  # 33% 감소
```

**효과**:
- 관성 감소 → 오버슈트 감소
- 제어 안정성 향상

### 2. **감속 구간 확대** ✅
```python
# Before
if remaining < 20°:

# After
if remaining < 30°:  # 50% 증가
```

**효과**:
- 더 일찍 감속 시작
- 부드러운 정지

### 3. **최소 속도 감소** ✅
```python
# Before
min_speed_scale = 0.3  # 30%

# After
min_speed_scale = 0.2  # 20%
```

**효과**:
- 목표 근처에서 더 느리게
- 정밀한 위치 제어

### 4. **회전 전 완전 정지** ✅
```python
def ensure_stopped(self):
    # 3초간 정지 명령 전송
    for i in range(60):
        publish(stop)
    time.sleep(1.0)  # 추가 안정화
```

**효과**:
- 이전 회전의 관성 제거
- 깨끗한 초기 상태

### 5. **단계별 명확한 로그** ✅
```
━━━ 1단계: 로봇 정지 중 ━━━
━━━ 2단계: 센서 데이터 수집 중 ━━━
━━━ 3단계: 초기 각도 기록 ━━━
━━━ 4단계: 회전 시작 ━━━
```

## 📋 예상 결과

### Before (rotation_test_20251016_150358.csv)
```
목표: 90°
과정: 0° → 176° → 8° → 169° → 9.74°
결과: 9.74° (오차 80.26°)
문제: 진동, 오버슈트, 역회전
```

### After (다음 테스트)
```
목표: 90°
과정: 0° → 완전정지 → 천천히 회전 → 85~95° 정지
결과: 88~92° (오차 <5°)
개선: 
  - 속도: 0.3 → 0.2 rad/s
  - 감속: 20° → 30° 전부터
  - 사전 정지: 3초 + 1초
```

## 🎯 다음 테스트 검증 사항

### 1. 오버슈트 감소
- ✓ 90° 목표 → 95° 이하 도달?
- ✓ 역회전 발생 없음?

### 2. 안정성
- ✓ 진동 없이 부드러운 회전?
- ✓ 한 방향으로만 회전?

### 3. 정확도
- ✓ 오차 < 5°?
- ✓ 85~95° 범위 내 정지?

## 🔧 추가 개선 가능 사항 (향후)

### A. Dead Zone 추가
```python
# 목표 근처에서는 더 이상 제어하지 않음
if abs(error) < 2°:
    stop()
    break
```

### B. 단방향 회전만 허용
```python
# 역회전 방지
if (initial_direction > 0 and error < -5°) or \
   (initial_direction < 0 and error > 5°):
    # 목표 초과 시 정지
    stop()
    break
```

### C. 속도 프로필 개선
```python
# S-curve 가속/감속
if remaining > 60°:
    speed = max_speed  # 최대 속도
elif remaining > 30°:
    speed = lerp(max_speed, medium_speed)  # 감속 1단계
else:
    speed = lerp(medium_speed, min_speed)  # 감속 2단계
```

## 📝 결론

### 주요 문제
1. **진동**: 오버슈트 → 역회전 → 오버슈트 반복
2. **과도한 속도**: 1.35 rad/s (명령의 4.5배)
3. **부족한 감속 구간**: 20° 남았을 때만 감속
4. **역방향 전속력 보정**: 오버슈트 보정이 너무 강함

### 적용된 해결책
1. ✅ 속도 감소: 0.3 → 0.2 rad/s
2. ✅ 감속 구간 확대: 20° → 30°
3. ✅ 최소 속도 감소: 30% → 20%
4. ✅ 회전 전 완전 정지
5. ✅ 명확한 단계별 진행

### 기대 효과
- 오버슈트 86° → <10°
- 진동 제거
- 정확도 향상 (±5° 이내)
