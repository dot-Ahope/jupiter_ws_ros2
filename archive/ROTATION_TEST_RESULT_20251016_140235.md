# 90도 회전 테스트 결과 분석 (rotation_test_20251016_140235.csv)

## 📊 테스트 결과 요약

### 실제 동작
- **시작 각도**: 87.06° (이전 테스트 종료 위치)
- **최종 각도**: -96.15° (실제: 96.15°)
- **총 회전량**: 183.21° ≈ **180°** (2배 회전!)
- **테스트 시간**: 3.66초
- **목표**: 90° 좌회전

### 물리적 결과
- **예상**: 87° + 90° = 177°
- **실제**: -96° (360° 기준 264°)
- **오버슈트**: 약 87° 초과

## 📈 센서 데이터 분석

### 1. 휠 오도메트리 (odom_raw)

```
시간(s)  yaw(rad)   yaw(deg)   각속도(rad/s)  상태
───────────────────────────────────────────────────────
0.055    1.519401    87.06      0.000       시작 (정지)
0.880    1.519401    87.06      0.000       대기 중
1.087    1.615685    92.57      0.990       회전 시작
1.292    1.850349   106.02      1.240       가속
1.498    2.107264   120.74      1.300       정속
1.703    2.377468   136.22      1.290       계속 회전
1.909    2.654002   152.06      1.340       계속 회전
2.116    2.885679   165.34      1.300       계속 회전
2.325   -3.107001  -178.02      1.320       180° 돌파 (wrap)
2.430   -2.996571  -171.69      1.320       계속 회전
2.635   -2.728163  -156.31      1.300       계속 회전
2.840   -2.457713  -140.82      1.300       계속 회전
3.045   -2.210847  -126.67      1.320       계속 회전
3.252   -1.949349  -111.69      1.320       계속 회전
3.457   -1.690160   -96.84      1.290       감속
3.662   -1.678177   -96.15      0.000       정지!
```

**분석**:
- ✅ 1.087초에 회전 시작 (87° → 93°)
- ⚠️ 2.325초에 180° 돌파 (각도 wrap: 178° → -178°)
- ⚠️ 3.662초에 정지 (-96° = 264°)
- ❌ **목표(177°) 초과 87도 더 회전**

### 2. 융합 오도메트리 (odom_filtered)

```
시간(s)  yaw(rad)   yaw(deg)   상태
────────────────────────────────────────
0.106    1.918310   109.91     시작 (이전 누적값)
0.931    1.918327   109.91     정지 상태
1.138    1.918324   109.91     변화 없음
...
3.509    1.918324   109.91     여전히 변화 없음
3.714    2.060789   118.07     갑자기 8° 증가
4.132    2.060952   118.08     고정
```

**분석**:
- ❌ EKF가 여전히 회전을 제대로 인식 못함
- ❌ 3.5초간 109.91°에 고정
- ❌ 정지 후에야 118°로 갑자기 점프
- ❌ **실제 회전량 180°를 8°로만 인식**

### 3. IMU 각속도

```
시간(s)  angular_z(rad/s)  상태
──────────────────────────────────
0.160   -0.000144         정지
0.366    4.644297         회전 감지
0.571    5.261957         계속
1.189    5.880150         계속
2.222    5.855635         계속
2.533    5.877485         계속
2.738    0.642031         감속 시작
2.943   -0.000677         정지
```

**분석**:
- ⚠️ 각속도 5.8~6.0 rad/s (명령: 0.3 rad/s)
- ⚠️ 여전히 **20배 과도한 증폭**
- ✅ 정지 타이밍은 정확 (2.738초)

## 🔍 문제점 분석

### 1. **각도 계산 오류: Angle Wrapping**

**문제 코드:**
```python
current_rotation = self.normalize_angle(
    self.odom_raw_yaw - self.initial_odom_raw_yaw
)
```

**실제 계산:**
```
초기: 87.06° (1.519 rad)
현재: -96.15° (-1.678 rad)
차이: -1.678 - 1.519 = -3.197 rad

normalize_angle(-3.197) = -3.197 + 2π = 2.086 rad = 119.5°
```

**하지만 실제로는:**
```
87° → 264° 회전 = 177° 회전 (180° 넘어감)

스크립트 계산:
-96° - 87° = -183° → normalize → 177°

그런데 목표가 90°인데 왜 177°까지?
```

### 2. **목표 각도 도달 조건 문제**

**코드:**
```python
if abs(current_rotation - target_angle_rad) < math.radians(5.0):
    break  # 85~95도 범위면 정지
```

**문제:**
- 초기 각도: 87° (이전 테스트 잔여)
- 목표: 87° + 90° = 177° (절대 각도)
- 하지만 코드는 **상대 회전량 90°**만 확인

**실제 동작:**
```
초기: 87°
회전 중: 92° → 106° → 120° → ... → 180° (wrap) → -178° → -96°
상대 회전량: 언제 90°?

87° → 177° 도달해야 하는데
스크립트는 "지금까지 얼마나 회전했나?"만 확인

normalize로 인해:
-96° - 87° = -183° → +180° = -3° ← 아직 90° 안됨으로 판단?
```

### 3. **초기 각도 리셋 안됨**

```
이전 테스트 종료: 87°
현재 테스트 시작: 87° (그대로 시작)

문제: base_node가 리셋되지 않고 누적
```

## 🛠️ 해결 방법

### 1. **절대 각도 기반 제어 (추천)** ✅

```python
# 목표 절대 각도 계산
target_absolute_yaw = self.normalize_angle(
    self.initial_odom_raw_yaw + target_angle_rad
)

while rclpy.ok():
    # 현재 절대 각도
    current_yaw = self.odom_raw_yaw
    
    # 목표까지 남은 각도 (최단 경로)
    error = self.normalize_angle(target_absolute_yaw - current_yaw)
    
    # 목표 도달 확인
    if abs(error) < math.radians(5.0):
        break
```

### 2. **누적 회전량 추적** ✅

```python
# 회전 방향 추적
self.total_rotation = 0.0
self.prev_yaw = self.initial_odom_raw_yaw

while rclpy.ok():
    # 이전 각도와 현재 각도 차이
    delta = self.normalize_angle(self.odom_raw_yaw - self.prev_yaw)
    
    # 누적
    self.total_rotation += delta
    self.prev_yaw = self.odom_raw_yaw
    
    # 목표 도달 확인
    if abs(self.total_rotation - target_angle_rad) < math.radians(5.0):
        break
```

### 3. **오도메트리 리셋 기능 추가**

```python
def reset_odometry(self):
    """오도메트리를 0으로 리셋"""
    # base_node 재시작 또는
    # 초기 오프셋 저장
    self.odom_offset = self.odom_raw_yaw
```

### 4. **감속 구간 추가 (오버슈트 방지)**

```python
remaining = abs(error)

if remaining < math.radians(20.0):  # 20도 남았을 때
    # 속도 감소
    angular_speed_scaled = angular_speed * (remaining / math.radians(20.0))
    twist.angular.z = max(angular_speed_scaled, 0.1)  # 최소 0.1
else:
    twist.angular.z = angular_speed
```

## 📋 조정 계획

### 우선순위 1: 각도 계산 수정 (즉시) 🔥

```python
# 방법 A: 절대 각도 기반 (간단)
target_absolute = normalize(initial + target)
error = normalize(target_absolute - current)
if abs(error) < 5°: stop

# 방법 B: 누적 추적 (정확)
total_rotation += normalize(current - prev)
if abs(total_rotation - target) < 5°: stop
```

### 우선순위 2: 감속 구간 추가 (오버슈트 방지)

```python
if remaining < 20°:
    speed *= (remaining / 20°)
```

### 우선순위 3: 오도메트리 리셋

```python
# 테스트 시작 전 리셋
ros2 service call /reset_odometry std_srvs/srv/Empty
```

### 우선순위 4: IMU 캘리브레이션 (근본 해결)

```python
# transbot_driver.py
sensitivity_gain = 1.0  # 2.0 → 1.0
```

## 📊 예상 결과 (수정 후)

### Before (현재)
```
시작: 87°
목표: +90° 회전 → 177°
실제: 264° (87° 오버슈트)
이유: wrap 계산 오류 + 감속 없음
```

### After (수정 후)
```
시작: 87°
목표: +90° 회전 → 177°
실제: 175~180° (±3° 오차)
방법: 절대 각도 기반 + 감속 구간
```

## 🎯 결론

### 성과
- ✅ odom_raw 기준으로 제어 성공 (10바퀴 → 2바퀴)
- ✅ 정지 명령 정상 동작 (3.66초에 정지)

### 남은 문제
- ❌ 각도 wrap 계산 오류 (90° 목표 → 180° 회전)
- ❌ 오버슈트 87° (감속 없음)
- ❌ EKF 여전히 비정상

### 즉시 조치 필요
1. **각도 계산 로직 수정** (절대 각도 또는 누적 추적)
2. **감속 구간 추가** (20° 남았을 때 속도 감소)
3. **테스트 전 오도메트리 확인** (초기 각도 0으로 시작)
