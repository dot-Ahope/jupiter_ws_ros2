# 🔍 진동 문제 분석 (rotation_test_20251016_165916.csv)

## 📊 테스트 결과

### 관찰된 동작
```
물리적 환경:
  좌회전 180° → 우회전 180° → 좌회전 180° → 우회전 180° → 반복 → 정지
```

### 센서 데이터

#### odom_raw (각도 변화)
```
시간(s)  yaw(°)    angular_z(rad/s)  상태
─────────────────────────────────────────────────
0.058    144.30    0.000            초기 (이전 테스트 잔여)
1.088    148.96    0.807            회전 시작
1.294    166.55    1.635            가속
1.499   -173.83    1.657            180° 점프! (wrap)
1.911   -136.62    1.700            계속 회전
2.529    -68.70    1.700            
3.148    -25.93   -0.022            정지 시도
3.353    -27.28   -0.131            
3.559    -40.38   -1.308            역회전 시작! ⚠️
3.970    -79.98   -1.744            급격한 역회전
4.798   -161.58   -1.744            180° 역회전
5.004    177.00   -1.657            wrap
5.632    135.21    0.414            다시 정회전 ⚠️
6.253    177.81    1.700            180° 정회전
6.459   -164.11    1.700            wrap
8.226    -27.99    0.000            최종 정지
```

**패턴**: 
```
144° → 166° → -173° (정회전 180°)
→ -27° (정지)
→ -40° → -161° (역회전 180°)
→ 135° → 177° (정회전 180°)
→ -164° (wrap)
→ -28° (정지)
```

#### IMU 각속도
```
시간(s)  angular_z(rad/s)  상태
────────────────────────────────
0.367     2.865            정회전
1.602     3.422            계속
2.220     1.979            감속
2.632    -1.497            역회전 시작! ⚠️
3.044    -3.330            급격한 역회전
3.867    -3.226            계속
4.490    -3.222            
4.901     0.207            정회전으로 전환! ⚠️
5.323     3.071            가속
6.148     3.481            계속
7.082     2.020            감속
7.290    -0.022            정지
```

## 🔍 근본 원인 분석

### 문제 1: **피드백 보정 2.18배가 과도함** ❌❌❌

#### 계산
```
하드웨어 피드백: 0.72 rad/s (추정)
보정 후: 0.72 × 2.18 = 1.57 rad/s
실제 IMU: 3.4 rad/s

비율: 3.4 / 1.57 = 2.17배 차이!
```

#### 결과
```
명령: 0.2 rad/s (90° 목표)
피드백 보정: 0.44 rad/s (×2.18)
실제 하드웨어: 3.4 rad/s (명령의 17배!)

오버슈트:
  목표: 90°
  실제: 180° (2배 초과!)
```

### 문제 2: **초기 각도가 144.30°** ⚠️

```
이전 테스트의 잔여 각도
→ 초기 각도가 0°가 아님
→ 목표 계산 오류 가능성
```

### 문제 3: **진동 메커니즘**

#### 사이클 1: 정회전 오버슈트
```
목표: 90° 좌회전 (144° → 234°)
실제: 180° 회전 (144° → 324° = -36° wrap)

error = 목표 - 현재
      = 234° - (-36°)
      = 270° (거대한 오차!)
```

#### 사이클 2: 역보정 오버슈트
```
error = 270° (양수)
→ 계속 정회전 명령
→ 또 180° 오버슈트

error = 목표 - 현재
      = 234° - 177°
      = 57° (여전히 양수)
→ 계속 회전...

언젠가 error < 0
→ 역회전 시작
→ 180° 역회전
→ 다시 오버슈트
```

## 💡 왜 180°씩 움직이는가?

### 가설 1: 감속 구간 부족 ⭐⭐⭐

#### 현재 설정
```python
# test_90degree_rotation.py
deceleration_angle = 30°  # Line 추정

현재 속도: 1.7 rad/s (실제)
목표: 90°
남은 각도 30° 진입 시: 60° 이미 회전

관성으로 추가 회전: ~120°
총 회전: 180°!
```

### 가설 2: 피드백 보정 이중 적용 ⭐⭐⭐

#### 데이터 흐름
```
1. 하드웨어 피드백: 0.72 rad/s
2. driver 보정: 0.72 × 2.18 = 1.57 rad/s
3. /transbot/get_vel 발행: 1.57 rad/s
4. base.cpp: angular_velocity_z_ = 1.57 × 1.0 = 1.57 rad/s

하지만 실제 하드웨어는 3.4 rad/s로 회전!

이유:
  - 명령: 0.2 rad/s
  - driver 변환: 40% PWM
  - 하드웨어: 3.4 rad/s 실행 (17배!)
  - 피드백: 0.72 rad/s 보고 (실제의 1/4.7)
  - 보정 후: 1.57 rad/s (여전히 실제의 1/2.2)
```

### 가설 3: 테스트 스크립트 로직 ⭐⭐

#### test_90degree_rotation.py 분석 필요
```python
# 예상 로직
error = target - current

if error > 0:
    angular_speed = 0.2
else:
    angular_speed = -0.2  # 역회전

문제:
  - error가 크면 계속 전속력
  - 오버슈트 → error 반대 → 전속력 역회전
  - 진동 발생
```

## 🔧 해결 방안

### Solution 1: 피드백 보정 제거 ⭐⭐⭐

**문제 인식**:
```
피드백 보정 2.18배는 잘못된 가정에서 출발:
  - 270° 실제 / 124° 측정 = 2.18
  - 하지만 이것은 명령-실제 불일치이지
  - 피드백 오류가 아님!

실제 상황:
  - 명령: 0.2 rad/s
  - 하드웨어: 3.4 rad/s 실행 (17배!)
  - 피드백: 0.72 rad/s 보고
  - 피드백 정확도: 0.72 vs 3.4 = 21%
```

**수정**:
```python
# transbot_driver.py - publish_velocity()
# Before
angular_correction = 2.18
msg.angular.z = float(ang) * angular_correction

# After
msg.angular.z = float(ang)  # 보정 제거
```

### Solution 2: 명령 레벨에서 보정 ⭐⭐

**위치**: cmd_vel_callback()
```python
# Before
turn_speed = angular_z * (100.0 / 0.5)  # 0.5 rad/s → 100%

# After
turn_speed = angular_z * (100.0 / (0.5 * 17))  # 17배 보정
# 즉, 8.5 rad/s → 100%
# 0.5 rad/s → 5.9% PWM
```

### Solution 3: 감속 구간 대폭 확대 ⭐

```python
# test_90degree_rotation.py
# Before
deceleration_angle = 30°  # 라디안

# After
deceleration_angle = 60°  # 2배 증가
# 또는
deceleration_angle = 90°  # 전체 구간 감속
```

### Solution 4: 속도 제한 ⭐⭐

```python
# cmd_vel_callback()
# 최대 각속도 제한
max_angular = 0.1  # rad/s (매우 낮게)

if angular_z > max_angular:
    angular_z = max_angular
elif angular_z < -max_angular:
    angular_z = -max_angular
```

## 📊 권장 조치

### 즉시 조치 (Phase 1)

**1. 피드백 보정 제거**
```python
# transbot_driver.py
msg.angular.z = float(ang)  # × 2.18 제거
```

**이유**:
- 피드백 보정은 잘못된 가정
- 하드웨어가 명령의 17배로 실행하는 것이 문제
- 피드백 자체는 상대적으로 정확

**2. 테스트**
```bash
./run_rotation_test.sh
```

**예상 결과**:
```
odom_raw:      120~130° (이전과 유사)
실제 물리:     270° (여전히 3배)
진동:          없음 ✓ (오버슈트 감소)
```

### 근본 해결 (Phase 2)

**3. 명령 스케일링 조정**
```python
# transbot_driver.py - cmd_vel_callback()
# 실제 측정: 0.2 rad/s 명령 → 3.4 rad/s 실행 (17배)

turn_speed = angular_z * (100.0 / (0.5 * 17))
# 또는 실측값 기반
turn_speed = angular_z * (100.0 / 8.5)
```

**4. 재테스트 및 미세 조정**

## 🎯 핵심 인사이트

### 잘못된 가정
```
❌ 피드백이 1/2.18로 과소 보고
✓ 하드웨어가 명령의 17배로 과도 실행
```

### 올바른 접근
```
문제: 명령 0.2 → 실제 3.4 (17배)
해결: 명령 레벨에서 1/17로 스케일링

NOT: 피드백 × 2.18
```

### 데이터 증거
```
IMU: 3.4 rad/s (실제 측정)
명령: 0.2 rad/s
비율: 17배

피드백: 0.72 rad/s
실제: 3.4 rad/s
비율: 4.7배 (피드백도 부정확하지만 명령-실제 차이가 주범)
```

## 📝 결론

**진동 원인**: 
1. ❌ 피드백 보정 2.18배 (잘못된 가정)
2. ❌ 하드웨어 17배 과도 실행
3. ❌ 오버슈트 → 역보정 → 오버슈트 반복

**해결책**:
1. ✅ 피드백 보정 제거
2. ✅ 명령 레벨 스케일링 (1/17)
3. ✅ 감속 구간 확대 (선택)

**다음 단계**:
1. transbot_driver.py 수정
2. 빌드 및 재시작
3. 테스트 실행
4. 결과 분석
