# TIL: 자율주행 로봇 Nav2 및 GPS 통합 (2026-01-17)

**작성자**: GitHub Copilot  
**프로젝트**: Jupiter Robot (ROS 2 Humble, Jetson)

---

## 1. 개요
오늘은 실내 오도메트리 안정화부터 시작하여 Nav2 스택 연동, 그리고 실외 GPS 자율주행을 위한 시스템 통합 작업을 진행했다.

## 2. 주요 작업 내용 및 해결 문제

### A. Lidar 오도메트리 안정화 (KISS-ICP)
- **문제**: 로봇 이동 시 오도메트리 좌표가 변하지 않거나, TF 트리가 끊기는 현상.
- **원인**: 
    1. 실내 좁은 공간에서 `min_range: 0.4` 설정이 근거리 특징점을 모두 제거함.
    2. `kiss-icp`가 비표준 프레임(`odom_lidar`)을 사용하여 TF 연결이 안 됨.
- **해결**:
    - `min_range`를 **0.1**로 수정.
    - 프레임 ID를 표준인 **`odom`**으로 변경.
    - 디버깅 토픽(`/kiss/local_map`) 활성화로 동작 검증 완료.

### B. Nav2 ("No Map" 모드) 구축
- **목표**: SLAM 없이 오도메트리와 센서만으로 장애물을 피하며 주행하는 기능 구현.
- **작업**:
    - `nav2_no_map_params.yaml` 작성 (`global_frame: odom`, Static Layer 제거).
    - **오류 해결**:
        - `planner_server` 사망: `height` 파라미터 타입 오류 (`50.0` -> `50` 수정).
        - `controller_server` 사망: 비평가(Critics) 설정 누락 수정.
        - 플래너 오류: `NavfnPlanner`의 Frame ID 버그 -> **`SmacPlanner2D`**로 교체하여 해결.
    - **Foxglove 연동**: 목표 토픽을 `/move_base_simple/goal`로 매핑하여 클릭 주행 성공.

### C. GPS 기반 자율주행 통합 (Outdoor Mode)
- **목표**: RTK-GPS를 융합하여 실외 좌표계(`map`) 기준 주행 시스템 구축.
- **작업**:
    - `jupiter_outdoor_gps.launch.py`에 통합 런치 구성:
        - **Local EKF**: Odom + IMU (기존)
        - **Global EKF**: GPS + Odom + IMU (신규, `map` 프레임 생성)
        - **NavSat Transform**: 위도/경도 -> XY 좌표 변환
        - **RTK Bridge**: NTRIP 클라이언트 및 U-blox 드라이버 실행
    - **이슈 수정**: 실제 RTK 런치가 발행하는 토픽(` /fix`)과 NavSat Transform이 기대하는 토픽(`/ublox_gps/fix`) 불일치 수정.

---

## 3. 결론 및 향후 계획
- **결과**: `jupiter_ws_ros2` 워크스페이스 내에서 실내(Odom only) 및 실외(GPS) 주행이 모두 가능한 하이브리드 아키텍처가 완성됨.
- **Next Step**: 실외로 나가서 실제 위성 신호를 수신하고, Global EKF가 `map` -> `odom` TF를 정상적으로 발행하는지 테스트 필요.
