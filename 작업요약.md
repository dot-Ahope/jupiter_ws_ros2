# 작업 환경 요약

## 1. 프로그램 개발 환경
* **하드웨어**
  * NVIDIA Jetson orin nano super 개발자 키트(ram 8GB)
  * 중국산 로봇 플랫폼
    - 링크 : https://ko.aliexpress.com/item/1005007466782991.html?spm=a2g0o.order_detail.order_detail_item.3.21625ccdv5C8Jf&gatewayAdapt=glo2kor
    - 사양 : 홀 인코더가 달린 DC12V 모터 2개가 달린 2륜차
    - 특이사항 : 홀 인코더 연결이 안되어 있음(연결시 추가 작업 필요)
  * 센서
    * 확장보드 연결 센서(stm32 mcu에 연결되어 시리얼로 패킷 전달)
      - IMU : ICM20948
      - 특이사항 : MCU가 패킷을 보내는 속도가 20hz임
    * 라이다 : siilar S2L(2d lidar), velodyne VLP-16(3d lidar)
      - 특이사항 : 3d 라이다가 현재 1개밖에 없음
    * RTK(Holybro ZED F9P)
      - 특이사항 : 6pin이라 지자계 데이터 받아올려면 추가 작업 필요
    * RealSense D455f
      - 200hz imu 설치
      - 특이사항 : 전방에 1개만 설치하여 사용중
  * 
 * **소프트웨어**:
  * **시스템 정보**
    - 장치: NVIDIA Jetson Orin Nano Super (Developer Kit)
    - JetPack / L4T: JetPack 6.2 (L4T 36.4.3)
    - 운영체제: Ubuntu 22.04 (Jammy)
    - 커널: 5.15.148-tegra
    - jetson-stats / jtop:
      - jetson-stats 버전: 4.3.1
      - jtop 서비스: Active
    - 주요 라이브러리:
      - CUDA: 12.6.85
      - cuDNN: 9.6.0.74
      - TensorRT: 10.7.0.23
      - VPI: 3.2.4
      - Vulkan: 1.3.204
      - OpenCV: 3.2.0 (CUDA: NO)
  * **워크스페이스:**
    - `jupiter_ws_ros2` (로컬 로봇 스택)
    - `isaac_ws_ros` (Isaac ROS: vSLAM, nvblox 등)

  * **주요 패키지 (`jupiter_ws_ros2/src`):**
    - **jupiter_bringup:** 로봇 드라이버 및 하드웨어 인터페이스 (`jupiter_driver.py`, `Rosmaster_Lib.py`).
        - `/home/jetson/jupiter_ws_ros2/src/jupiter_bringup/jupiter_bringup/jupiter_driver.py` : 하드웨어 인터페이스를 사용한 ROS2 노드
        - `/home/jetson/jupiter_ws_ros2/src/jupiter_bringup/jupiter_bringup/Rosmaster_Lib.py`: MCU(로봇 보드)와의 직렬 통신을 구현한 하드웨어 인터페이스 라이브러리
          - Rosmaster 클래스 하나를 제공하며, 모터 제어, 센서(IMU·자이로·가속도·마그넷·엔코더) 리포트 파싱, 서보/로봇암 제어, 버전/설정 요청 등을 처리
    - **jupiter_nav_VO:** vSLAM 기반 Nav2 통합용 패키지 — 런치별 관련 패키지와 역할은 아래와 같이 분리됨.
      - **`nav2_vslam_navigation.launch.py` (Navigation-only):**
        - 목적: Nav2의 `navigation_launch.py`를 호출하여 vSLAM으로부터의 오도메트리/TF를 사용해 경로 계획 및 로컬 제어만 수행.
        - 관련 패키지: `nav2_bringup` (Nav2 런치/노드), `jupiter_nav_VO` (파라미터 파일: `config/nav2_params_vslam.yaml`), `jupiter_nav` (플래너/유틸).
        - 특징: 맵 서버 및 AMCL 비활성화, vSLAM(외부)에서 공급되는 `/visual_slam/tracking/odometry`와 TF를 전제로 함.

      - **`nav2_vslam_integrate.launch.py` (Integration / Robot bringup + vSLAM):**
        - 목적: 하드웨어 드라이버, 로봇 상태 발행, 그리고 Isaac vSLAM을 포함한 통합 런치.
        - 관련 패키지: `jupiter_bringup` (`jupiter_driver` 노드, 드라이버 파라미터), `jupiter_description` (URDF), `robot_state_publisher`, `joint_state_publisher`, `isaac_ros_visual_slam` (vSLAM), `realsense2_camera` (카메라/IMU), `tf2_ros`, `rclcpp_components` (composable 컨테이너), `velodyne*` (코스트맵용, 현재 주석처리/선택적).
        - 특징: 하드웨어 초기화 및 TF(예: `camera_link` -> `base_link`로 이름 변경) 설정, vSLAM과 드라이버를 한 프로세스로 통합하거나 별도 컨테이너로 실행.

    - **jupiter_nav:** 네비게이션 헬퍼 및 플래너 래퍼
    - **jupiter_base / jupiter_ctrl:** 저수준 베이스 컨트롤러 및 명령 인터페이스(휠 인코더로 오도메트리 계산 - 현재 미사용)
    - **jupiter_msgs:** 전역에서 쓰이는 커스텀 메시지/서비스 정의
    - **sllidar_ros2, jupiter_laser, rf2o_laser_odometry, kiss-icp:** 기존 라이다/오도메트리 패키지(일부 런치에서 비활성화됨)

  * **주요 패키지 (`isaac_ws_ros/src`):**
    - **isaac_ros_visual_slam:** Isaac vSLAM 노드 및 Realsense 통합 런치(수정되어 TF를 `base_link`로 발행).
    - **isaac_ros_nvblox / nvblox_ros:** costmap/포인트클라우드용 3D 매핑 표현.
    - **isaac_ros_common:** Isaac 패키지 공통 유틸리티 및 브리지 인터페이스.

  * **변경된 파일 / 중요 설정:**
    - `/home/jetson/jupiter_ws_ros2/src/jupiter_nav_VO/config/nav2_params_vslam.yaml`: vSLAM 전용 로컬라이제이션에 맞춘 Nav2 파라미터(컨트롤러 주파수, `min_speed_theta`, 가속도 제한, 비용지도 포인트클라우드 소스 `/visual_slam/vis/observations_cloud`).
    - `/home/jetson/jupiter_ws_ros2/src/jupiter_bringup/jupiter_bringup/jupiter_driver.py` : MCU/드라이버 인터페이스
      - 특이사항
        - 카메라 imu로 인해 확장보드의 IMU 비활성화 옵션 추가
        - `cmd_vel`에 대한 데드존 보정(각속도/선속도 보정) 적용(로버가 cmd_vel의 linear 약 2.0, angular 약 2.5 이상에서만 움직이기 시작하는 문제 때문에, 전달하기 전에 선형속도에 1.9, 각속도에 2.4를 더해줌)
    - `isaac_ros_visual_slam` 런치: TF 트리가 Nav2에 연결되도록 `base_link`로 TF 발행하도록 isaac_ros_visual_slam_realsense.launch.py 수정.

  * **현재 관찰된 소프트웨어 문제:**
    - 하드웨어 데드존: 모터가 큰 명령(선형 약 2.0, 각속도 약 2.5)에서만 동작을 시작함. 현재 드라이버에서 보상 로직을 적용했으나, 근본적 해결은 MCU PID/펌웨어 튜닝 권장.
    - Jetson CPU 부하: Isaac vSLAM과 Nav2를 높은 빈도로 실행하면 제어 루프 주기(예: 20Hz)를 놓치는 현상이 발생했음. 안정화를 위해 `nav2_params_vslam.yaml`에서 컨트롤러 주파수를 20Hz에서 5Hz로 낮춤.

  * **빌드 / 실행 메모:**
    - 변경한 패키지 빌드 예시:

      ```bash
      colcon build --symlink-install --packages-select jupiter_bringup jupiter_nav_VO
      source install/setup.bash
      ```

    - 실행 예시:

      ```bash
      ros2 launch jupiter_nav_VO nav2_vslam_integrate.launch.py
      # 또는 작업중인 Nav2 런치:
      ros2 launch jupiter_nav_VO nav2_vslam_navigation.launch.py
      ```

  * **권장 / 다음 단계(소프트웨어):**
    - 데드존 보정 코드를 MCU 펌웨어로 옮겨 근본적으로 해결하거나, 최소한 `jupiter_driver`에서 ROS 파라미터로 설정 가능한 보정값으로 노출할 것.
    - 불필요한 vSLAM/rviz 로그를 낮추고 처리 빈도를 줄여 Jetson의 CPU 부하를 낮출 것.
    - `jupiter_nav_VO`에 vSLAM 전용 Nav2 설정 및 실행 방법을 설명하는 간단한 README 추가 권장.

  * **상태:** 대부분 통합 변경 적용 완료. 노드를 재시작한 뒤 `/cmd_vel`에 대한 실제 모터 응답과 `/visual_slam/tracking/odometry`의 TF 연결 상태를 검증할 것.
