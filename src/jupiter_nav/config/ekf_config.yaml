ekf_filter_node:
  ros__parameters:
    # ============================================================
    # 기본 EKF 설정 - 최소 구성 (복잡한 튜닝 제거)
    # ============================================================
    frequency: 15.0
    sensor_timeout: 1.0
    two_d_mode: true
    publish_tf: true
    transform_time_offset: 0.0
    transform_timeout: 0.0
    
    # 프레임
    map_frame: map
    odom_frame: odom
    base_link_frame: base_footprint
    world_frame: odom
    
    # ============================================================
    # 오도메트리 센서 (KISS-ICP Lidar Odometry - Absolute Pose optimized)
    # ============================================================
    odom0: /odom_rf2o #/kiss/odometry
    odom0_config: [true,  true,  false,    # x, y, z
                   false, false, true,     # r, p, yaw (Consider absolute yaw from LiDAR)
                   false, false, false,    # vx, vy, vz
                   false, false, false,    # vroll, vpitch, vyaw
                   false, false, false]    # ax, ay, az
    
    odom0_differential: false
    odom0_relative: false
    odom0_queue_size: 10
    
    # ⭐ RF2O 공분산 - 선형 속도 신뢰, 회전 속도 불신
    odom0_twist_covariance: [0.001, 0.0, 0.0, 0.0, 0.0, 0.0,   # vx 매우 신뢰
                             0.0, 0.001, 0.0, 0.0, 0.0, 0.0,   # vy 매우 신뢰
                             0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                             0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                             0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                             0.0, 0.0, 0.0, 0.0, 0.0, 1000.0]  # vyaw 무시 (매우 큰 공분산)
    
    # ============================================================
    # IMU 센서 (회전 담당)
    # ============================================================
    imu0: /imu/data_calibrated
    imu0_config: [false, false, false,     # 위치
                  false, false, false,     # 방향
                  false, false, false,     # 속도
                  false, false, true,      # vyaw (Z축 회전 속도)만 사용
                  false, false, false]
    
    imu0_differential: false
    imu0_relative: false
    imu0_queue_size: 10
    imu0_remove_gravitational_acceleration: true
    
    # ⭐ IMU 센서 공분산 - 각속도 신뢰도 향상 (더 낮은 불확실성)
    # IMU는 각속도에서 훨씬 정확: 0.005rad/s 불확실성 (기존 0.01 → 0.005) ⭐⭐
    imu0_angular_velocity_covariance: [0.0001, 0.0, 0.0,      # 0.005^2 (0.0001 → 0.000025) ⭐⭐
                                       0.0, 0.0001, 0.0,      # 0.005^2 ⭐⭐
                                       0.0, 0.0, 0.0001]      # 0.005^2 ⭐⭐
    
    # ============================================================
    # Process Noise - IMU 우선 융합 강화 ⭐⭐
    # ============================================================
    # yaw_vel (index 11) 설정 전략 재조정:
    # - IMU covariance: 0.000025 (0.005^2) - 매우 정확
    # - Odom covariance: 0.04 (0.2^2) - 신뢰도 낮음
    # - Process noise: 0.00005 (IMU의 2배) - IMU 중심 융합 ⭐⭐
    #
    # Kalman Gain 계산:
    #   K_IMU = 0.00005 / (0.00005 + 0.000025) = 0.67 (센서 신뢰 33%)
    #   K_Odom = 0.00005 / (0.00005 + 0.04) ≈ 0.001 (센서 신뢰 99.9%)
    #   → IMU 절대 우선, Odom은 보조
    #
    # 목표: 회전 정확도 최대화 → SLAM 루프 클로저 성공률 향상
    process_noise_covariance: [0.05, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.05, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.03, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.03, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.025, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.025, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.04, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.00005, 0.0, 0.0, 0.0,  # ⭐⭐ 0.0002 → 0.00005
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.015]

    # ============================================================
    # 주의: Process Noise[11] (vyaw)는 위 행렬의 12번째 행, 12번째 열 = index [11][11]
    # 위 행렬은 1차원 배열 (15×15 행렬의 대각선 요소만)
    # index 11 = 12번째 요소 = 0.00005 (4번째 줄, 12번째 값) ⭐⭐
    # ============================================================
    
    # ============================================================
    # Initial Covariance - 기본값 사용
    # ============================================================
    initial_estimate_covariance: [1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9]
