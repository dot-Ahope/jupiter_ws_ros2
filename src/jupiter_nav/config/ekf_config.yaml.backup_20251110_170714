ekf_filter_node:
  ros__parameters:
    # ============================================================
    # 기본 EKF 설정 - 드리프트 최소화 ⭐⭐⭐
    # ============================================================
    frequency: 50.0                # 30 → 50Hz (더 빠른 업데이트로 드리프트 감소) ⭐⭐⭐
    sensor_timeout: 0.1
    two_d_mode: true
    publish_tf: true
    
    # 프레임
    map_frame: map
    odom_frame: odom
    base_link_frame: base_footprint
    world_frame: odom
    
    # ============================================================
    # 오도메트리 센서
    # ============================================================
    odom0: /odom_raw
    odom0_config: [true,  true,  false,    # x, y
                   false, false, true,     # yaw
                   true,  true,  false,    # vx, vy
                   false, false, true,     # vyaw
                   false, false, false]
    
    odom0_differential: false    # 절대값 사용 (가장 단순)
    odom0_relative: false
    odom0_queue_size: 10
    
    # ⭐ Odom 센서 공분산 재조정 (위치 불확실성 증가, 각속도 신뢰도 감소)
    # 측정 불확실성: 위치 0.15m (증가), 각도 0.1rad (증가), 속도 0.2m/s, 각속도 0.2rad/s (감소)
    odom0_pose_covariance: [0.0225, 0.0, 0.0, 0.0, 0.0, 0.0,    # 0.01 → 0.0225 (0.15^2) ⭐⭐
                            0.0, 0.0225, 0.0, 0.0, 0.0, 0.0,    # 0.01 → 0.0225 (0.15^2) ⭐⭐
                            0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                            0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                            0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                            0.0, 0.0, 0.0, 0.0, 0.0, 0.01]      # yaw: 0.1^2 (0.0025 → 0.01) ⭐⭐
    
    odom0_twist_covariance: [0.04, 0.0, 0.0, 0.0, 0.0, 0.0,
                             0.0, 0.04, 0.0, 0.0, 0.0, 0.0,
                             0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                             0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                             0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                             0.0, 0.0, 0.0, 0.0, 0.0, 0.04]     # vyaw: 0.2^2 (0.05 → 0.04) ⭐⭐
    
    # ============================================================
    # IMU 센서
    # ============================================================
    imu0: /imu/data_calibrated
    imu0_config: [false, false, false,     # 위치
                  false, false, false,     # 방향
                  false, false, false,     # 속도
                  false, false, true,      # vyaw만 사용
                  false, false, false]
    
    imu0_differential: false
    imu0_relative: false
    imu0_queue_size: 10
    imu0_remove_gravitational_acceleration: true
    
    # ⭐ IMU 센서 공분산 - 각속도 신뢰도 최대화 (드리프트 감소) ⭐⭐⭐
    # IMU는 각속도에서 훨씬 정확: 0.003rad/s 불확실성 (0.005 → 0.003, 더 엄격) ⭐⭐⭐
    # 목적: 회전 드리프트 최소화
    imu0_angular_velocity_covariance: [0.000009, 0.0, 0.0,      # 0.003^2 (0.000025 → 0.000009) ⭐⭐⭐
                                       0.0, 0.000009, 0.0,      # 0.003^2 ⭐⭐⭐
                                       0.0, 0.0, 0.000009]      # 0.003^2 ⭐⭐⭐
    
    # ============================================================
    # Process Noise - 드리프트 최소화 전략 ⭐⭐⭐
    # ============================================================
    # 목표: odom 드리프트를 최소화하기 위해 process noise 감소
    # 
    # yaw_vel (index 11) 설정:
    # - IMU covariance: 0.000009 (0.003^2) - 매우 정확
    # - Odom covariance: 0.04 (0.2^2) - 신뢰도 낮음
    # - Process noise: 0.00002 (IMU의 2배) - 드리프트 억제 ⭐⭐⭐
    #
    # Kalman Gain (센서 가중치):
    #   K_IMU = 0.00002 / (0.00002 + 0.000009) ≈ 0.69 (IMU 신뢰 31%)
    #   K_Odom = 0.00002 / (0.00002 + 0.04) ≈ 0.0005 (센서 신뢰 99.95%)
    #   → IMU 절대 우선, 드리프트 누적 최소화
    #
    # 위치 process noise도 감소 (0.05 → 0.03):
    # - 위치 드리프트 억제
    # - 센서 측정값에 더 의존
    process_noise_covariance: [0.03, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  # x: 0.05→0.03 ⭐
                              0.0, 0.03, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  # y: 0.05→0.03 ⭐
                              0.0, 0.0, 0.06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.03, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.03, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.04, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  # yaw: 0.06→0.04 ⭐
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.02, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  # vx: 0.025→0.02 ⭐
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.02, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  # vy: 0.025→0.02 ⭐
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.04, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.00002, 0.0, 0.0, 0.0,  # vyaw: 0.00005→0.00002 ⭐⭐⭐
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.015]

    # ============================================================
    # 주의: Process Noise[11] (vyaw)는 위 행렬의 12번째 행, 12번째 열 = index [11][11]
    # 위 행렬은 1차원 배열 (15×15 행렬의 대각선 요소만)
    # index 11 = 12번째 요소 = 0.00005 (4번째 줄, 12번째 값) ⭐⭐
    # ============================================================
    
    # ============================================================
    # Initial Covariance - 기본값 사용
    # ============================================================
    initial_estimate_covariance: [1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0,
                                 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9]
