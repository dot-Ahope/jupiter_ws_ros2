slam_toolbox:
  ros__parameters:
    # Plugin params
    solver_plugin: solver_plugins::CeresSolver
    ceres_linear_solver: SPARSE_NORMAL_CHOLESKY
    ceres_preconditioner: SCHUR_JACOBI
    ceres_trust_strategy: LEVENBERG_MARQUARDT
    ceres_dogleg_type: TRADITIONAL_DOGLEG
    ceres_loss_function: HuberLoss  # 변경: 이상치에 더 강인한 Huber Loss 사용

    # ROS Parameters
    odom_frame: odom
    map_frame: map
    base_frame: base_footprint  # EKF가 odom->base_footprint 발행하므로 일치
    scan_topic: /scan
    mode: mapping #localization

    # 맵 경로를 명확하게 지정하고 map_start_at_dock을 false로 설정
    map_file_name: ""
    map_start_pose: [0.0, 0.0, 0.0]
    map_start_at_dock: false

    debug_logging: false
    throttle_scans: 4              # 2 -> 4 (부하 감소 및 데이터 드롭)
    transform_publish_period: 0.1  # ⭐ TF 발행 주기 (0.05->0.1, 10Hz) - CPU 부하 감소
    map_update_interval: 5.0       # ⭐ 맵 업데이트 주기 (2.0->5.0) - CPU 부하 감소
    resolution: 0.05               # 맵 해상도
    max_laser_range: 4.0
    minimum_time_interval: 0.5     # ⭐ 업데이트 최소 시간 간격 (0.2->0.5)
    transform_timeout: 0.2         # 타임아웃 감소 (0.5->0.2) - 큐 쌓임 방지, 지연되면 즉시 드롭
    tf_buffer_duration: 30.
    stack_size_to_use: 40000000    # 대형 맵 직렬화를 위한 스택 크기
    enable_interactive_mode: false # 인터랙티브 모드 비활성화 - 성능 향상

    # General Parameters
    use_scan_matching: true
    use_scan_barycenter: true
    minimum_travel_distance: 0.1   # ⭐ 최소 이동 거리 (0.05→0.1, 10cm) - 업데이트 빈도 감소
    minimum_travel_heading: 0.05   # ⭐ 최소 회전 각도 (0.03→0.05, 약 2.9도) - 업데이트 빈도 감소
    scan_buffer_size: 100          # ⭐ 버퍼 크기 대폭 증가 (50→100) - 메시지 드롭 완전 방지
    scan_buffer_maximum_scan_distance: 4.0  # 최대 스캔 거리 확대 (3.5→4.0) ⭐
    
    # ========================================
    # 실시간 스캔 매칭 (적당히 엄격) ⭐
    # 목적: 오도메트리 보조, 급격한 변화 방지
    # ========================================
    link_match_minimum_response_fine: 0.50  # 0.10 → 0.20 (엄격) - 잘못된 매칭 방지 ⭐⭐
    link_scan_maximum_distance: 1.5         # 2.5 → 1.5 (축소) - 인접 스캔만 매칭 ⭐⭐
    
    # ========================================
    # 루프 클로저 (매우 엄격하게) ⭐⭐⭐
    # 목적: 지도 중첩 방지, 높은 확신만 허용
    # ========================================
    loop_search_maximum_distance: 4.0       # 4.0 → 4.0 (유지) - 가까운 위치만 루프 클로저 ⭐⭐
    do_loop_closing: true
    loop_match_minimum_chain_size: 15       # 10 → 15 (매우 엄격) - 더 많은 증거 요구 ⭐⭐⭐
    loop_match_maximum_variance_coarse: 1.5 # 2.0 → 1.5 (엄격) - 분산 제한 강화 ⭐⭐
    loop_match_minimum_response_coarse: 0.55 # 0.45 → 0.55 (매우 엄격) - 응답값 기준 상향 ⭐⭐⭐
    loop_match_minimum_response_fine: 0.65   # 0.50 → 0.65 (매우 엄격) - 정밀 매칭 기준 강화 ⭐⭐⭐

    # Correlation Parameters - Correlation Parameters
    correlation_search_space_dimension: 0.6 # 검색 공간 확장 (0.5→0.6)
    correlation_search_space_resolution: 0.01
    correlation_search_space_smear_deviation: 0.1

    # ========================================
    # Correlation Parameters - Loop Closure
    # 루프 클로저 검색 공간 축소 (정확도 우선) ⭐⭐
    # ========================================
    loop_search_space_dimension: 6.0        # 8.0 → 6.0 (축소) - 잘못된 매칭 범위 제한 ⭐⭐
    loop_search_space_resolution: 0.02      # 0.03 → 0.02 (고해상도) - 정밀 탐색 ⭐⭐
    loop_search_space_smear_deviation: 0.01 # 0.02 → 0.01 (매우 엄격) - 불확실성 최소화 ⭐⭐

    # ========================================
    # Scan Matcher Parameters
    # ========================================
    
    # 스캔 매칭 페널티 강화 (오도메트리 우선) ⭐⭐
    distance_variance_penalty: 0.8          # 0.5 → 0.8 (엄격) - 거리 변화 제한 ⭐⭐
    angle_variance_penalty: 1.2             # 0.8 → 1.2 (엄격) - 회전 변화 제한 ⭐⭐
    minimum_angle_penalty: 0.95             # 0.80 → 0.95 (엄격) - 오도메트리 신뢰 ⭐⭐
    minimum_distance_penalty: 0.7           # 0.5 → 0.7 (엄격) - 오도메트리 신뢰 ⭐⭐

    fine_search_angle_offset: 0.00349     
    coarse_search_angle_offset: 0.349   
    coarse_angle_resolution: 0.0349        
    use_response_expansion: true
