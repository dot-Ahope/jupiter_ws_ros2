ekf_filter_node:
  ros__parameters:
    # ============================================================
    # 기본 EKF 설정 - 최소 구성
    # ============================================================
    frequency: 30.0              # 필터 업데이트 주파수
    sensor_timeout: 0.1          # 센서 타임아웃
    two_d_mode: true            # 2D 평면 이동
    publish_tf: true            # TF 발행
    
    # 프레임 설정
    map_frame: map
    odom_frame: odom
    base_link_frame: base_footprint
    world_frame: odom
    
    # ============================================================
    # 오도메트리 센서 설정
    # ============================================================
    odom0: /odom_raw
    odom0_config: [true,  true,  false,    # x, y 위치
                   false, false, true,     # yaw 각도
                   true,  true,  false,    # vx, vy 속도
                   false, false, true,     # yaw 각속도
                   false, false, false]    # 가속도
    
    odom0_differential: false    # ⭐ 절대값 사용 (가장 단순)
    odom0_relative: false
    odom0_queue_size: 10
    
    # ============================================================
    # IMU 센서 설정
    # ============================================================
    imu0: /imu/data_calibrated
    imu0_config: [false, false, false,     # 위치
                  false, false, false,     # 방향 (Odom 사용)
                  false, false, false,     # 선속도
                  false, false, true,      # yaw 각속도만 사용
                  false, false, false]     # 선가속도
    
    imu0_differential: false     # ⭐ 절대값 사용
    imu0_relative: false
    imu0_queue_size: 10
    imu0_remove_gravitational_acceleration: true

    # IMU 회전 감지 최적화 설정 - imu_calib 보정 데이터 활용
    imu0_differential: true        # 변화량 사용 (회전 변화 감지)
    imu0_relative: false          # ⭐ differential과 충돌 방지 (true → false)
    imu0_queue_size: 20           # 큐 크기 유지
    imu0_remove_gravitational_acceleration: true
    
    # ⭐ 공분산 제거: 센서 데이터에서 자동 계산 (명시적 값이 오히려 거부 유발)
    # imu0_angular_velocity_covariance: 삭제 (자동 계산)
    
    # imu_calib 보정된 데이터를 위한 노이즈 모델링
    # ⭐ 90°까지는 IMU가 정확하므로 threshold 완화하여 EKF가 더 수용
    imu0_pose_rejection_threshold: 100.0    # ⭐ 5.0 → 100.0 (거의 거부 안함)
    imu0_twist_rejection_threshold: 100.0   # ⭐ 15.0 → 100.0 (거의 거부 안함)
    imu0_linear_acceleration_rejection_threshold: 100.0  # 10.0 → 100.0

    # 센서 제한 범위 - raw IMU 특성 반영
    imu0_linear_acceleration_limits: [-10.0, 10.0]   
    imu0_angular_velocity_limits: [-3.0, 3.0]        # 회전 속도 범위 유지
    
    # 프로세스 노이즈 공분산 행렬 - 좌우 회전 정확도 최적화
    # ⭐ yaw: 0.03 (증가로 센서 균형), yaw_vel: 0.01 (증가로 IMU 편향 감소)
    # 위치(x,y): 0.003, yaw: 0.03 (회전 노이즈 증가), 
    # 속도(vx,vy): 0.008, yaw_vel: 0.01 (센서 균형),
    # 가속도: 0.003
    process_noise_covariance: [0.003, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.003, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.005, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.005, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.005, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.03, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.008, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.008, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.005, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.005, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.003, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.003, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.003]
    
    # 시간 관련 설정
    transform_time_offset: 0.0
    transform_timeout: 0.0
    
    # 초기 상태 - 절대 좌표 센서 부재로 인한 불확실성 반영
    initial_state: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]

    # 초기 추정의 공분산 - 절대 방향 측정 불가능성 반영
    # ⭐ yaw: 10.0 (1000.0 → 10.0, 초기 수렴 안정화), yaw_vel: 0.5 (0.2 → 0.5, 약간 증가)
    # 위치 불확실성: 0.1, yaw 불확실성: 10.0, 속도 불확실성: 0.5, 각속도 불확실성: 0.5
    initial_estimate_covariance: [
      0.1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 10.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01]
