ekf_filter_node:
  ros__parameters:
    # EKF 제어 파라미터 - transbot_library 기반 최적화
    frequency: 10.0               # 필터 업데이트 주파수 (높은 정확도를 위해 복원)
    sensor_timeout: 0.15          # 센서 timeout 단축 (빠른 반응성)
    two_d_mode: true             
    publish_tf: true             
    publish_acceleration: false   
    
    # 고급 제어 파라미터
    reset_on_time_jump: true
    smooth_lagged_data: true
    history_length_in_seconds: 1.0    # 히스토리 증가로 더 나은 평활화
    predict_to_current_time: true     # 현재 시간으로 예측 (지연 보상)
    
        # 입력 및 출력 프레임 설정
    map_frame: map                 
    odom_frame: odom               
    base_link_frame: base_footprint # TF 트리에 맞게 설정
    world_frame: odom              

    # 오도메트리 데이터 활용 설정 - 실제 발행되는 토픽명으로 수정
    odom0: /odom_raw              # base_node가 실제 발행하는 토픽명
    odom0_config: [true, true, false,   # x, y 위치 활용 
                  false, false, true,   # yaw 각도 활용 (주요 회전 정보)
                  true, true, false,    # x, y 선속도 활용
                  false, false, true,   # yaw 각속도 활성화 (휠 오도메트리 + IMU 융합)
                  false, false, false]

    # transbot_library 기반 오도메트리 가중치 설정 - 큐 오버플로우 방지
    odom0_differential: true       # 변화량 사용 (휠 슬립 보상)
    odom0_relative: false         # 절대 측정값 사용
    odom0_queue_size: 25          # 큐 크기 대폭 증가 - 큐 오버플로우 방지
    
    # transbot_library 기반 오도메트리 노이즈 모델링  
    odom0_pose_rejection_threshold: 5.0     # 오도메트리 위치 신뢰도 적절히 설정
    odom0_twist_rejection_threshold: 3.0    # 속도 신뢰도 적절히 설정

    # IMU 데이터 활용 설정 - Raw IMU 직접 사용 (TF 충돌 방지)
    # imu_filter_madgwick 제거로 raw IMU를 직접 EKF에서 처리
    # EKF의 센서 융합 (Odom + IMU)으로 드리프트 보정
    imu0: /imu/data_calibrated     # /imu/data_filtered → /imu/data_calibrated (raw)
    imu0_config: [false, false, false,
                  false, false, false,  # yaw 각도 비활성화 (오도메트리가 담당)
                  false, false, false,
                  false, false, true,   # yaw 각속도 전담 (회전 변화 정밀 추적)
                  false, false, false]

    # IMU 회전 감지 최적화 설정 - raw IMU는 더 noisy하므로 파라미터 조정
    imu0_differential: true        # 변화량 사용 (회전 변화 감지)
    imu0_relative: true           # 상대적 측정값 사용
    imu0_queue_size: 20           # 큐 크기 유지
    imu0_remove_gravitational_acceleration: true
    
    # raw IMU를 위한 노이즈 모델링 - rejection threshold 증가
    imu0_pose_rejection_threshold: 5.0      # 2.0 → 5.0 (raw는 더 noisy)
    imu0_twist_rejection_threshold: 2.0     # 0.5 → 2.0 (raw 각속도 노이즈 허용)
    imu0_linear_acceleration_rejection_threshold: 10.0  # 8.0 → 10.0

    # 센서 제한 범위 - raw IMU 특성 반영
    imu0_linear_acceleration_limits: [-10.0, 10.0]   
    imu0_angular_velocity_limits: [-3.0, 3.0]        # 회전 속도 범위 유지
    
    # 프로세스 노이즈 공분산 행렬 - 좌우 회전 정확도 최적화
    # 위치(x,y): 0.003, yaw: 0.015 (회전 노이즈 감소), 
    # 속도(vx,vy): 0.008, yaw_vel: 0.01 (각속도 노이즈 감소),
    # 가속도: 0.003
    process_noise_covariance: [0.003, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.003, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.005, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.005, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.005, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.015, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.008, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.008, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.005, 0.0, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.005, 0.0, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.003, 0.0, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.003, 0.0,
                              0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.003]
    
    # 시간 관련 설정
    transform_time_offset: 0.0
    transform_timeout: 0.0
    
    # 초기 상태 - 절대 좌표 센서 부재로 인한 불확실성 반영
    initial_state: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]

    # 초기 추정의 공분산 - 절대 방향 측정 불가능성 반영
    # 위치: 중간 불확실성, yaw: 매우 큰 불확실성 (SLAM이 점진적으로 보정)
    # 위치 불확실성: 0.1, yaw 불확실성: 1000.0, 속도 불확실성: 0.5, 각속도 불확실성: 0.2
    initial_estimate_covariance: [
      0.1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 1000.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.2, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01]
