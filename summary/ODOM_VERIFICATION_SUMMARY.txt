오도메트리(odom) 검증 요약
작성일: 2025-09-02

체크리스트
- 조이스틱 → /cmd_vel 매핑 위치 확인: `transbot_ctrl/transbot_ctrl/transbot_joy.py`
- /cmd_vel → 모터 매핑 확인: `transbot_bringup/transbot_bringup/transbot_driver.py::cmd_vel_callback`
- 오도메트리 생성 로직 확인: `transbot_base/src/base.cpp::velCallback` (vel 구독, 적분, /odom_raw 발행 및 TF 브로드캐스트)
- 런타임 증거 수집: `/odom_raw`, `/transbot/imu`, TF (tf2_echo) 확인 완료

핵심 요약
- 데이터 흐름: 조이스틱 → /cmd_vel(Twist) → transbot_driver(cmd_vel_callback) → 모터 제어 → 하드웨어 속도 리포트(bot.get_velocity()) → /transbot/get_vel(Twist) 발행 → transbot_base.velCallback 구독 → 적분 → /odom_raw(nav_msgs/Odometry) 발행 및 odom->base TF 전송
- 따라서 조이스틱 매핑(gear, deadzone, expo, limits)을 변경하면 /cmd_vel 값이 달라지고, 모터 출력(%)이 변하며 실제 하드웨어 속도가 달라져 오도메트리 적분 결과(위치/방향)에 영향을 줌.

검증에서 발견된 위험 포인트
- `transbot_driver.cmd_vel_callback`의 스케일 상수(base_speed = linear_x * (100.0 / 0.2), turn_speed = angular_z * (100.0 / 0.5))는 하드웨어 사양과 불일치 시 모터 출력 왜곡을 유발.
- 모터 포화(클램프) 발생 시 실제 속도와 명령한 속도 간 차이가 커져 odom 오차 발생.
- 동일 노드(transbot_driver) 다중 인스턴스 존재 시 퍼블리시 충돌/경합 가능성.
- odom 메시지의 covariance가 0 또는 미설정(또는 기본값)인 경우 필터/경계 검증에 불리.

런타임 증거 (요약)
- `/odom_raw`: pose.position, orientation 및 twist 포함 메시지 발행됨.
- `/transbot/imu`: angular_velocity, linear_acceleration 발행(orientation 미제공).
- TF: `base_link` ↔ `odom` 변환이 주기적으로 갱신되어 위치/방향 출력함.

권장 테스트 절차 (간단 재현)
1) 단위/스케일 확인: `bot.get_velocity()`의 단위가 m/s인지 확인.
2) 고정 속도 테스트
   - 같은 고정 linear 명령(예: 0.05 m/s)을 10초 동안 퍼블리시.
   - `/transbot/get_vel`과 `/odom_raw`의 누적 거리 비교.
3) 매핑 민감도 테스트
   - `transbot_joy`의 `linear_Gear` 또는 `linear_speed_limit`을 변경해 동일한 조작을 수행하고 `/transbot/get_vel`과 `/odom_raw`의 차이 관찰.

실행 명령 예시
. /home/user/transbot_ws_ros2/install/setup.bash
ros2 launch transbot_bringup bringup.launch.py
ros2 topic list | grep -E '(^/odom_raw$|^/transbot/imu$|/transbot/get_vel|/cmd_vel)'
# 고정 속도 퍼블리시 (별도 터미널)
ros2 topic pub /cmd_vel geometry_msgs/Twist "{linear: {x: 0.05, y:0.0, z:0.0}, angular: {x:0.0, y:0.0, z:0.0}}" -r 10
ros2 topic echo /transbot/get_vel --once
ros2 topic echo /odom_raw --once

권장 개선사항(우선순위)
- `transbot_driver`의 스케일 상수를 런타임 파라미터로 전환(하드웨어별 튜닝 가능)
- `base_node`의 `linear_scale`을 사용해 스케일 보정 가능 (테스트 후 설정)
- 모터 포화 시 로그 경고 추가
- odom covariance 현실적 값 설정 또는 EKF에 적절히 설정
- 자동 회귀 테스트 스크립트 작성(고정 속도/회전, 오차 리포트)

다음 제안 작업
- 자동 회귀 테스트 스크립트 작성 및 실행(A)
- 드라이버 파라미터화(스케일을 파라미터로 변경) 및 패치 적용(B)
- 간단 보정(C): 고정 속도 테스트로 `linear_scale` 값 계산

원하시면 선택(A/B/C)을 알려주시면 바로 진행하겠습니다.
