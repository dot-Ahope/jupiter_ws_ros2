# IMU 중심 주행 테스트 및 캘리브레이션 가이드

휠 인코더가 제거됨에 따라, 로봇의 위치 추정(Odometry)은 **IMU(회전)**와 **Lidar SLAM(위치 보정)**에 전적으로 의존하게 됩니다.
따라서 IMU의 정확도가 매우 중요합니다.

## 1. 변경 사항 요약 (EKF 설정)

`jupiter_nav/config/ekf_config.yaml` 파일이 수정되었습니다.
- **휠 인코더(`odom0`) 비활성화**: 더 이상 휠 회전수를 사용하여 위치를 추정하지 않습니다.
- **IMU 신뢰도 대폭 상향**:
  - `imu0_angular_velocity_covariance`: 0.000025 (매우 낮음 = 매우 신뢰함)
  - `process_noise_covariance` (Yaw Velocity): 0.00005 (IMU 데이터를 우선시하도록 설정)

이 설정으로 인해 EKF는 **"로봇이 회전하는 것은 IMU가 말하는 대로다"**라고 거의 맹신하게 됩니다.

---

## 2. 필수: 자이로스코프(Gyro) 캘리브레이션

가장 중요한 것은 **회전(Yaw)**의 정확도입니다.
현재 시스템은 **부팅 시 자동으로 자이로 바이어스를 보정**하도록 설정되어 있습니다.

### ⚠️ 주의사항: 부팅 시 정지
로봇을 켜거나 `jupiter_full_system`을 실행할 때, **처음 5~10초간 로봇을 절대 움직이지 마세요.**
- `imu_calib` 노드가 처음 500개의 데이터를 수집하여 "0점(정지 상태)"을 잡습니다.
- 이때 로봇이 움직이면, "움직이는 상태"를 "정지 상태"로 오인하여, 주행 중 계속 회전하는 것처럼(Drift) 인식됩니다.

---

## 3. 선택: 가속도계(Accel) 캘리브레이션 (정밀 보정)

로봇이 기울어져 있거나 가속도 센서 오차가 크다면 수행합니다. (로봇을 뒤집거나 세울 수 있어야 함)

1. **캘리브레이션 노드 실행**:
   ```bash
   ros2 run imu_calib do_calib_node --ros-args -p output_file:=/home/jetson/jupiter_ws_ros2/imu_calib.yaml -r /imu:=/jupiter/imu
   ```
2. **지시에 따라 6면 방향 정렬**:
   - 화면에 나오는 지시대로 로봇(또는 센서)을 X+, X-, Y+, Y-, Z+, Z- 방향으로 돌려가며 엔터를 칩니다.
   - 완료되면 `imu_calib.yaml` 파일이 생성/갱신됩니다.
3. **적용**:
   - 프로그램을 재시작하면 새 파일이 적용됩니다.

---

## 4. 테스트 및 검증 절차

### 단계 1: IMU 방향 확인 (기본)
작성해드린 스크립트로 물리적 방향이 맞는지 확인합니다.
```bash
python3 ~/jupiter_ws_ros2/check_imu_direction.py
```
- **좌회전(CCW)** 시: `Angular Vel Z`가 **양수(+)**
- **앞으로 밀기** 시: `Linear Acc X`가 **양수(+)**

### 단계 2: 회전 정확도 테스트 (Rviz)
1. 로봇을 벽과 평행하게 둡니다.
2. Rviz에서 LaserScan을 켭니다.
3. 로봇을 제자리에서 **360도(한 바퀴)** 회전시킵니다.
4. **확인 포인트**:
   - 실제 로봇이 제자리로 돌아왔을 때, Rviz 상의 로봇도 정확히 제자리(같은 각도)를 보고 있는가?
   - **오차 발생 시**: IMU가 360도 돌았다고 생각하는데 실제로는 350도만 돌았거나 370도 돌았을 수 있습니다.
   - **해결**: `imu_calib.yaml`이 없다면 생성하거나, EKF 설정을 더 튜닝해야 할 수 있습니다.

### 단계 3: SLAM 위치 추정 테스트
휠 오도메트리가 없으므로, **직진/후진 시 Rviz 상에서 로봇이 움직이지 않을 수 있습니다.** (IMU는 등속 직선 운동을 감지 못함)
하지만 **SLAM(Lidar 매칭)**이 켜져 있다면, Lidar가 벽을 보고 위치를 업데이트해 줄 것입니다.

1. SLAM 실행 (`use_nav2_slam:=false` 상태에서 `slam_toolbox` 사용 권장)
2. 로봇을 천천히 **직진**시킵니다.
3. **확인 포인트**:
   - Rviz에서 로봇 모델이 앞으로 이동하는가? (Lidar 매칭에 의해 이동해야 함)
   - 만약 이동하지 않고 제자리에서 벽만 다가오는 것처럼 보인다면, SLAM 파라미터 튜닝이 필요합니다.

---

## 5. 문제 해결 (Troubleshooting)

- **증상**: 로봇이 가만히 있는데 Rviz에서 뱅글뱅글 돈다.
  - **원인**: 부팅 시 로봇이 흔들렸거나, 자이로 바이어스 보정 실패.
  - **해결**: 로봇을 평평한 곳에 가만히 두고 재부팅/재실행.

- **증상**: 직진했는데 지도가 망가진다.
  - **원인**: 휠 인코더 없이 IMU만으로는 직진 거리를 알 수 없음. SLAM이 Lidar 매칭을 놓침.
  - **해결**: 천천히 이동하여 Lidar가 매칭을 유지하도록 함. 특징점(벽, 장애물)이 많은 환경에서 테스트.
